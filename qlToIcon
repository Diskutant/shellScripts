#!/bin/bash

if [ "$1" == '-p' ]
then
  qlArg=""
  sips="true"
  shift
else
  qlArg="-i"
  sips="false"
fi

i=1
count=$#

while [ "$1" != '' ]
do
  target=$1
  filename=`basename "$1"`
  image="${TMPDIR}${filename}.png"
  rsrc="${TMPDIR}icn.rsrc"

  # Create a thumbnail from the file preview
  qlmanage -t $qlArg -s 1024 -o ${TMPDIR} "$target" &>/dev/null
  if [ $sips == "true" ] 
  then
    sips -p 1024 1024 "$image" &>/dev/null
  fi

  # apply the image to itself as an thumbnail icon
  fileicon -q set "$target" "$image"

  # clean up
  rm "$image"

  echo "$i/$count Icon applied to \"$filename\""
  ((i++))
  shift
done
